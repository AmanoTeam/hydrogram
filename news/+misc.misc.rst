Various fixes, improvements and micro-optimizations.
